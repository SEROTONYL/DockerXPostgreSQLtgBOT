// Package casino ‚Äî slots.go —Ä–µ–∞–ª–∏–∑—É–µ—Ç –¥–≤–∏–∂–æ–∫ —Å–ª–æ—Ç-–º–∞—à–∏–Ω—ã 5x6.
// –°–æ–¥–µ—Ä–∂–∏—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Å–µ—Ç–∫–∏, –ø—Ä–æ–≤–µ—Ä–∫—É –ª–∏–Ω–∏–π –∏ –ø–æ–¥—Å—á—ë—Ç –≤—ã–∏–≥—Ä—ã—à–µ–π.
// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–ª—É—á–∞–π–Ω—ã—Ö —á–∏—Å–µ–ª.
package casino

import (
	"crypto/rand"
	"fmt"
	"math/big"
)

// Paylines ‚Äî 20 —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤—ã–∏–≥—Ä—ã—à–Ω—ã—Ö –ª–∏–Ω–∏–π.
// –ö–∞–∂–¥–∞—è –ª–∏–Ω–∏—è ‚Äî –º–∞—Å—Å–∏–≤ –∏–∑ 5 –∏–Ω–¥–µ–∫—Å–æ–≤ —Å—Ç—Ä–æ–∫ (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ –∫–∞–∂–¥—ã–π —Ä–∏–ª).
// –ò–Ω–¥–µ–∫—Å—ã —Å—Ç—Ä–æ–∫ –æ—Ç 0 –¥–æ 5 (6 —Å—Ç—Ä–æ–∫).
//
// –ü—Ä–∏–º–µ—Ä: –ª–∏–Ω–∏—è {0,0,0,0,0} ‚Äî –≤–µ—Ä—Ö–Ω—è—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è.
// –õ–∏–Ω–∏—è {0,1,2,1,0} ‚Äî V-–æ–±—Ä–∞–∑–Ω–∞—è –ª–∏–Ω–∏—è.
var Paylines = [20][5]int{
	// –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏ (6 —à—Ç—É–∫ ‚Äî –ø–æ –æ–¥–Ω–æ–π –Ω–∞ —Å—Ç—Ä–æ–∫—É)
	{0, 0, 0, 0, 0}, // –õ–∏–Ω–∏—è 1: –≤–µ—Ä—Ö–Ω—è—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è
	{1, 1, 1, 1, 1}, // –õ–∏–Ω–∏—è 2
	{2, 2, 2, 2, 2}, // –õ–∏–Ω–∏—è 3: —Å—Ä–µ–¥–Ω—è—è
	{3, 3, 3, 3, 3}, // –õ–∏–Ω–∏—è 4
	{4, 4, 4, 4, 4}, // –õ–∏–Ω–∏—è 5
	{5, 5, 5, 5, 5}, // –õ–∏–Ω–∏—è 6: –Ω–∏–∂–Ω—è—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è

	// V-–æ–±—Ä–∞–∑–Ω—ã–µ –∏ –∑–∏–≥–∑–∞–≥–æ–æ–±—Ä–∞–∑–Ω—ã–µ –ª–∏–Ω–∏–∏
	{0, 1, 2, 1, 0}, // –õ–∏–Ω–∏—è 7: V –≤–Ω–∏–∑
	{5, 4, 3, 4, 5}, // –õ–∏–Ω–∏—è 8: V –≤–≤–µ—Ä—Ö (–ø–µ—Ä–µ–≤—ë—Ä–Ω—É—Ç–∞—è)
	{1, 0, 1, 0, 1}, // –õ–∏–Ω–∏—è 9: –∑–∏–≥–∑–∞–≥ –≤–µ—Ä—Ö
	{4, 5, 4, 5, 4}, // –õ–∏–Ω–∏—è 10: –∑–∏–≥–∑–∞–≥ –Ω–∏–∑

	// –î–∏–∞–≥–æ–Ω–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
	{0, 1, 2, 3, 4}, // –õ–∏–Ω–∏—è 11: –¥–∏–∞–≥–æ–Ω–∞–ª—å ‚Üò
	{4, 3, 2, 1, 0}, // –õ–∏–Ω–∏—è 12: –¥–∏–∞–≥–æ–Ω–∞–ª—å ‚Üó
	{1, 2, 3, 4, 5}, // –õ–∏–Ω–∏—è 13: –¥–∏–∞–≥–æ–Ω–∞–ª—å ‚Üò (—Å–¥–≤–∏–≥)
	{5, 4, 3, 2, 1}, // –õ–∏–Ω–∏—è 14: –¥–∏–∞–≥–æ–Ω–∞–ª—å ‚Üó (—Å–¥–≤–∏–≥)

	// –°–ª–æ–∂–Ω—ã–µ –ª–∏–Ω–∏–∏
	{2, 1, 0, 1, 2}, // –õ–∏–Ω–∏—è 15: W
	{3, 4, 5, 4, 3}, // –õ–∏–Ω–∏—è 16: M
	{0, 0, 1, 2, 2}, // –õ–∏–Ω–∏—è 17: —Å—Ç—É–ø–µ–Ω—å –≤–Ω–∏–∑
	{5, 5, 4, 3, 3}, // –õ–∏–Ω–∏—è 18: —Å—Ç—É–ø–µ–Ω—å –≤–≤–µ—Ä—Ö
	{1, 2, 1, 2, 1}, // –õ–∏–Ω–∏—è 19: –≤–æ–ª–Ω–∞
	{3, 2, 3, 2, 3}, // –õ–∏–Ω–∏—è 20: –≤–æ–ª–Ω–∞ (–∑–µ—Ä–∫–∞–ª—å–Ω–∞—è)
}

// GenerateGrid —Å–æ–∑–¥–∞—ë—Ç —Å–µ—Ç–∫—É 5x6 —Å–∏–º–≤–æ–ª–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –≤–∑–≤–µ—à–µ–Ω–Ω–æ–π —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏.
// –ö–∞–∂–¥–∞—è –ø–æ–∑–∏—Ü–∏—è –Ω–∞ —Å–µ—Ç–∫–µ –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–µ—Å–æ–≤ —Å–∏–º–≤–æ–ª–æ–≤.
//
// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
//   - symbols: –º–∞—Å—Å–∏–≤ —Å–∏–º–≤–æ–ª–æ–≤ —Å –≤–µ—Å–∞–º–∏ (–æ–±—ã—á–Ω—ã–µ –∏–ª–∏ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–ª—è RTP)
//
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
//   - Grid: —Å–µ—Ç–∫–∞ 5x6 —Å —ç–º–æ–¥–∑–∏ —Å–∏–º–≤–æ–ª–æ–≤
//   - error: –æ—à–∏–±–∫–∞ –µ—Å–ª–∏ –∫—Ä–∏–ø—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª
func GenerateGrid(symbols []Symbol) (Grid, error) {
	var grid Grid

	// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–∞–∂–¥—É—é –ø–æ–∑–∏—Ü–∏—é –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ
	for reel := 0; reel < 5; reel++ {
		for row := 0; row < 6; row++ {
			emoji, err := selectWeightedSymbol(symbols)
			if err != nil {
				return grid, fmt.Errorf("–æ—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∏–º–≤–æ–ª–∞ [%d][%d]: %w", reel, row, err)
			}
			grid[reel][row] = emoji
		}
	}

	return grid, nil
}

// selectWeightedSymbol –≤—ã–±–∏—Ä–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–π —Å–∏–º–≤–æ–ª –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–µ—Å–æ–≤.
// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç crypto/rand –¥–ª—è –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏.
//
// –ê–ª–≥–æ—Ä–∏—Ç–º:
//  1. –°—á–∏—Ç–∞–µ–º —Å—É–º–º—É –≤—Å–µ—Ö –≤–µ—Å–æ–≤
//  2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ —Å—É–º–º—ã-1
//  3. –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ —Å–∏–º–≤–æ–ª–∞–º, –Ω–∞–∫–∞–ø–ª–∏–≤–∞—è –≤–µ—Å–∞
//  4. –ö–æ–≥–¥–∞ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π –≤–µ—Å –ø—Ä–µ–≤—ã—à–∞–µ—Ç —Å–ª—É—á–∞–π–Ω–æ–µ —á–∏—Å–ª–æ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–∏–º–≤–æ–ª
func selectWeightedSymbol(symbols []Symbol) (string, error) {
	// –®–∞–≥ 1: —Å—É–º–º–∞ –≤–µ—Å–æ–≤
	totalWeight := 0
	for _, s := range symbols {
		totalWeight += s.Weight
	}

	// –®–∞–≥ 2: –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–ª—É—á–∞–π–Ω–æ–µ —á–∏—Å–ª–æ
	n, err := rand.Int(rand.Reader, big.NewInt(int64(totalWeight)))
	if err != nil {
		return "", fmt.Errorf("–æ—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ª—É—á–∞–π–Ω–æ–≥–æ —á–∏—Å–ª–∞: %w", err)
	}

	// –®–∞–≥ 3-4: –≤—ã–±–∏—Ä–∞–µ–º —Å–∏–º–≤–æ–ª
	randomValue := int(n.Int64())
	cumulative := 0
	for _, s := range symbols {
		cumulative += s.Weight
		if randomValue < cumulative {
			return s.Emoji, nil
		}
	}

	// –ù–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–∫–∏ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–≤—ã–π —Å–∏–º–≤–æ–ª
	return symbols[0].Emoji, nil
}

// CheckPaylines –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å–µ 20 –ª–∏–Ω–∏–π –Ω–∞ –≤—ã–∏–≥—Ä—ã—à.
// –£—á–∏—Ç—ã–≤–∞–µ—Ç Wild (‚≠ê) ‚Äî –æ–Ω –∑–∞–º–µ–Ω—è–µ—Ç –ª—é–±–æ–π —Å–∏–º–≤–æ–ª –∫—Ä–æ–º–µ Scatter.
//
// –ê–ª–≥–æ—Ä–∏—Ç–º –¥–ª—è –∫–∞–∂–¥–æ–π –ª–∏–Ω–∏–∏:
//  1. –ë–µ—Ä—ë–º –ø–µ—Ä–≤—ã–π —Å–∏–º–≤–æ–ª (–∏–ª–∏ Wild)
//  2. –°—á–∏—Ç–∞–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ
//  3. Wild —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –ª—é–±—ã–º —Å–∏–º–≤–æ–ª–æ–º (–∫—Ä–æ–º–µ Scatter)
//  4. –ï—Å–ª–∏ 3+ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π ‚Äî —ç—Ç–æ –≤—ã–∏–≥—Ä—ã—à
func CheckPaylines(grid Grid, bet int64) []WinLine {
	var wins []WinLine

	for lineIdx, line := range Paylines {
		// –°–æ–±–∏—Ä–∞–µ–º —Å–∏–º–≤–æ–ª—ã –Ω–∞ –ª–∏–Ω–∏–∏
		symbols := make([]string, 5)
		for reel := 0; reel < 5; reel++ {
			symbols[reel] = grid[reel][line[reel]]
		}

		// –û–ø—Ä–µ–¥–µ–ª—è–µ–º ¬´–±–∞–∑–æ–≤—ã–π¬ª —Å–∏–º–≤–æ–ª (–ø–µ—Ä–≤—ã–π –Ω–µ-Wild)
		baseSymbol := ""
		for _, s := range symbols {
			if s != WildEmoji && s != ScatterEmoji {
				baseSymbol = s
				break
			}
		}

		// –ï—Å–ª–∏ –≤—Å–µ Wild ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º Wild –∫–∞–∫ –±–∞–∑–æ–≤—ã–π
		if baseSymbol == "" {
			baseSymbol = WildEmoji
		}

		// –°—á–∏—Ç–∞–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ
		matchCount := 0
		for _, s := range symbols {
			if s == baseSymbol || s == WildEmoji {
				matchCount++
			} else {
				break // –¶–µ–ø–æ—á–∫–∞ –ø—Ä–µ—Ä–≤–∞–ª–∞—Å—å
			}
		}

		// –ú–∏–Ω–∏–º—É–º 3 –¥–ª—è –≤—ã–∏–≥—Ä—ã—à–∞
		if matchCount >= 3 {
			payout := calculateLinePayout(baseSymbol, matchCount, bet)
			if payout > 0 {
				wins = append(wins, WinLine{
					LineIndex: lineIdx,
					Symbol:    baseSymbol,
					Count:     matchCount,
					Payout:    payout,
				})
			}
		}
	}

	return wins
}

// calculateLinePayout –≤—ã—á–∏—Å–ª—è–µ—Ç –≤—ã–ø–ª–∞—Ç—É –¥–ª—è –æ–¥–Ω–æ–π –≤—ã–∏–≥—Ä—ã—à–Ω–æ–π –ª–∏–Ω–∏–∏.
func calculateLinePayout(symbol string, count int, bet int64) int64 {
	// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –≤—ã–ø–ª–∞—Ç—ã (7Ô∏è‚É£ –∏ üíé)
	if special, ok := SpecialPayouts[symbol]; ok {
		if multiplier, ok := special[count]; ok {
			return bet * multiplier
		}
	}

	// –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –≤—ã–ø–ª–∞—Ç–∞
	if multiplier, ok := PayoutTable[count]; ok {
		return bet * multiplier
	}

	return 0
}

// CountScatters –ø–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∫–∞—Ç—Ç–µ—Ä–æ–≤ (üé∞) –Ω–∞ –≤—Å–µ–π —Å–µ—Ç–∫–µ.
// –°–∫–∞—Ç—Ç–µ—Ä—ã —Å—á–∏—Ç–∞—é—Ç—Å—è –≤ –õ–Æ–ë–û–ô –ø–æ–∑–∏—Ü–∏–∏, –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω–∞ –ª–∏–Ω–∏–∏.
func CountScatters(grid Grid) int {
	count := 0
	for reel := 0; reel < 5; reel++ {
		for row := 0; row < 6; row++ {
			if grid[reel][row] == ScatterEmoji {
				count++
			}
		}
	}
	return count
}

// CalculateScatterBonus –≤—ã—á–∏—Å–ª—è–µ—Ç –±–æ–Ω—É—Å –æ—Ç —Å–∫–∞—Ç—Ç–µ—Ä–æ–≤.
// 3 —Å–∫–∞—Ç—Ç–µ—Ä–∞: 100 + 1 —Ñ—Ä–∏—Å–ø–∏–Ω
// 4 —Å–∫–∞—Ç—Ç–µ—Ä–∞: 200 + 2 —Ñ—Ä–∏—Å–ø–∏–Ω–∞
// 5 —Å–∫–∞—Ç—Ç–µ—Ä–æ–≤: 500 + 3 —Ñ—Ä–∏—Å–ø–∏–Ω–∞
func CalculateScatterBonus(scatterCount int) (int64, int) {
	if bonus, ok := ScatterPayouts[scatterCount]; ok {
		return bonus.Bonus, bonus.FreeSpins
	}
	return 0, 0
}

// FormatGrid —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å–µ—Ç–∫—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram.
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
//
//	üçí üçã üíé üçä üçá
//	üçã üçí ‚≠ê üçã üçâ
//	üçä üíé üçí üçí üçí
//	üçá üçã üçâ üíé üçã
//	üçâ üçä üçá üçã üçä
//	üçí üçá üçã üçâ üíé
func FormatGrid(grid Grid) string {
	result := ""
	for row := 0; row < 6; row++ {
		for reel := 0; reel < 5; reel++ {
			if reel > 0 {
				result += " "
			}
			result += grid[reel][row]
		}
		result += "\n"
	}
	return result
}
